name: CI

on:
    push:
        branches: [main, dev]
    pull_request:
        branches: [main, dev]

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    changes:
        name: Detect changes
        runs-on: ubuntu-latest
        outputs:
            backend: ${{ steps.filter.outputs.backend }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Paths filter
              id: filter
              uses: dorny/paths-filter@v3
              with:
                  filters: |
                      backend:
                        - 'src/**'
                        - 'package.json'
                        - 'eslint.config.js'
                        - '.github/workflows/**'

    lint:
        name: Lint (root only)
        runs-on: ubuntu-latest
        needs: changes
        if: needs.changes.outputs.backend == 'true'
        permissions:
            contents: read
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - name: Install root dependencies
              run: npm ci

            - name: ESLint
              run: npx eslint "src/**" "*.js"

            - name: Prettier (check only)
              run: npx prettier --check .

    test:
        name: Test (Node ${{ matrix.node }})
        runs-on: ubuntu-latest
        needs: [changes, lint]
        if: needs.changes.outputs.backend == 'true'
        permissions:
            contents: read
        strategy:
            fail-fast: false
            matrix:
                node: [18, 20, 22]
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node }}
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Create .env file
              run: |
                  touch .env
                  echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN_TEST }}" >> .env
                  echo "CLIENTID=${{ secrets.CLIENTID_TEST }}" >> .env
                  echo "MONGODB_URL=${{ secrets.MONGODB_URL_TEST }}" >> .env
                  echo "LOG_LEVEL=INFO" >> .env
                  echo "LOG_TO_FILE=false" >> .env

            - name: Run tests
              run: npm test
              env:
                  NODE_ENV: test
